#include "malware_unzip.h"

int malware_unzip(const char *gz_filepath, const char *maldataset_dir, const char *original_filename)
{
	gzFile zfp;
	char buf[1024];
	FILE *fp;
	char *new_filepath;
	
	// Open GZ file
	if ((zfp = gzopen(gz_filepath, "rb")) == NULL)
	{
		printf("Error: cannot read file (%s).\n", gz_filepath);
		return 1;	
	}

	// declare target file path
	size_t new_filepath_len = strlen(maldataset_dir) + strlen(original_filename) + 2;
	new_filepath = (char*) calloc(new_filepath_len, sizeof(char));
	
	if (new_filepath == NULL) {
		printf("Error: cannot allocate in heap memory.\n");
		return 1;	
	}

	// construct target file path
	sprintf(new_filepath, "%s/%s", maldataset_dir, original_filename);
	
	// write target file and decompress
	fp = fopen(new_filepath, "wb");
	int len;

	if (fp == NULL)
	{
		printf("Error: cannot write file (%s).\n", new_filepath);
		return 1;
	}

	while (len = gzread(zfp, buf, 1023))
	{
		buf[len] = '\0';
		fwrite(buf, 1, len, fp);
	}

	// close target file
	fclose(fp);

	// close GZ file
	gzclose(zfp);

	return 0;
}

