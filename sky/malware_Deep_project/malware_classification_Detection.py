import numpy as np
import shutil
import os, sys,string
import cv2
from numpy import argmax
from keras.models import load_model
import shutil
import subprocess

categorical = ["malware", "normal"]

def Dataization(img_path):
    image_w = 150
    image_h = 150
    img = cv2.imread(img_path)
    img = cv2.resize(img, None, fx=image_w/img.shape[1], fy=image_h/img.shape[0])
    return (img/256)

def main():
    src = []
    name = []
    test = []
    image_dir = "/home/lmsky/PycharmProjects/malware_Deep_project/result/"
    for file in os.listdir(image_dir):
        if (file.find('.png') is not -1):
            src.append(image_dir + file)
            name.append(file)
            test.append(Dataization(image_dir + file))

    test = np.array(test)
    model = load_model("/home/lmsky/PycharmProjects/malware_Deep_project/malware_model/malware_classification150_3dim.h5")
    predict = model.predict_classes(test)

    print("----malware Detection-----")
    malware = 0
    normal = 0
    for i in range(len(test)):
        print(name[i] + " : , Predict : " + str(categorical[predict[i]]))
        if str(categorical[predict[i]]) == "malware":
            str_name = str(name[i]).replace(".png", '')
            p = subprocess.Popen(["/media/lmsky/A279-DD87/kisa_dataset/대용량_정상,악성파일1/대용량_정상,악성파일1/zip/./malware.exe",
                                  "/media/lmsky/A279-DD87/kisa_dataset/대용량_정상,악성파일1/대용량_정상,악성파일1/sample_test1/" +
                                  str_name], stdout=subprocess.PIPE)
            
            malware += 1
        else:
            normal += 1

    print("malware : {}, normal : {}".format(malware, normal))
