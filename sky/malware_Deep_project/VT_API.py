# -*- coding: utf-8 -*-
import urllib.request
import urllib.parse
import urllib
import json
import time
import sys
import hashlib
import os

def sha256():
    vir = "/media/lmsky/A279-DD87/kisa_dataset/대용량_정상,악성파일1/대용량_정상,악성파일1/sample_test1/"
    datafile = os.listdir(vir)
    print(datafile)
    for filename in datafile:
        f = open(vir+filename, 'rb')
        data = f.read()
        f.close()

         #print("SHA-256: " + hashlib.sha256(data).hexdigest())
        f = open("/media/lmsky/A279-DD87/kisa_dataset/대용량_정상,악성파일1/대용량_정상,악성파일1/result/"+filename+".txt", 'w')
        data = hashlib.sha256(data).hexdigest()
        f.write(data)
        f.close()

    data1 = os.listdir("/media/lmsky/A279-DD87/kisa_dataset/대용량_정상,악성파일1/대용량_정상,악성파일1/result/")
    print(data1)
    for i in data1:
        VT_KEY = '6cb74ffb2ad90a09d904fc954f559e9d8febb2d7e85156afdc18f44d5e30f10d'
        # 바이러스토탈 api키, 가입 후 제공받을 수 있음 1분에 4개 제한
        HOST = 'www.virustotal.com'
        SCAN_URL = 'https://www.virustotal.com/vtapi/v2/file/scan'
        REPORT_URL = 'https://www.virustotal.com/vtapi/v2/file/report'
        md5str = ''
        # md5 값 담을 변수 선언

        fields = [('apikey', VT_KEY)]
        # 전달할 apikey 값 담기
        vt="/media/lmsky/A279-DD87/kisa_dataset/대용량_정상,악성파일1/대용량_정상,악성파일1/result/"+ i
        sys.stdout = open(vt+"_result.txt",'a') #악성코드 인자값
        txtf = open(vt, 'r')
        ##txtf = open(r'/content/sample_data/test.txt','r')
        # test.txt에 md5값을 담아두고 'r'  read함

        while True:
            # while문으로 반복 돌림
            line = txtf.readline()
            md5str = line.strip('\n')
            # 한 줄 씩 읽음. 개행으로 구분함
            if not md5str: break
            parameters = {'resource': md5str, 'apikey': VT_KEY}
            data = urllib.parse.urlencode(parameters).encode("utf-8")
            req = urllib.request.Request(REPORT_URL, data, headers={'User-Agent':'Chrome/66.0.3359.181'})
            response = urllib.request.urlopen(req)
            data = response.read()

            data = json.loads(data)
            # 데이터를 json형태로 읽어서 data변수에 담음.
            md5 = data.get('sha256', {})
            scan = data.get('scans', {})
            # 바이러스토탈에서 응답값 던져줄 때 내가 필요한  md5값과 scan결과 값 파싱
            keys = scan.keys()
            # keys는 바이러스토탈에서 지원하는 백신엔진 목록
            print(" ")
            print("==========================Virus Total Loading==========================")
            print("=========================================================================")
            # 바이러스 토탈이 지원하는 백신 중 하나도 탐지되는게 없으면 '{}'값이 md5에 들어감. 그러므로 "no match"출력
            if md5 == {}:
                print(" !!!!!!!!! Sorry, No Match !!!!!!!!! ")
                # new 폴더로 파일을 이동시켜 압축
            else:
                print(md5)
                # malware 폴더로 파일을 이동시켜 압축
            print("==========================================================================")
            time.sleep(10)
            # 1분에 4개로 제한되어 있어, 20초씩 sleep시켜줌.
            for key in keys:
                if key == 'AhnLab-V3':
                    print('%-20s : %s' % (key, scan[key]['result']))
                elif key == 'ALYac':
                    print('%-20s : %s' % (key, scan[key]['result']))
                elif key == 'nProtect':
                    print('%-20s : %s' % (key, scan[key]['result']))
                elif key == 'ViRobot':
                    print('%-20s : %s' % (key, scan[key]['result']))
        txtf.close()
        print("+++++++++++++++++++++++++++clear+++++++++++++++++++++++++++")
